<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserCredentialsService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">nivlalulu-app</a> &gt; <a href="index.source.html" class="el_package">com.nivlalulu.nnpro.service.impl</a> &gt; <span class="el_source">UserCredentialsService.java</span></div><h1>UserCredentialsService.java</h1><pre class="source lang-java linenums">package com.nivlalulu.nnpro.service.impl;

import com.nivlalulu.nnpro.common.email.IMailSender;
import com.nivlalulu.nnpro.common.exceptions.ConflictException;
import com.nivlalulu.nnpro.common.exceptions.NotFoundException;
import com.nivlalulu.nnpro.common.exceptions.TooManyRequestsException;
import com.nivlalulu.nnpro.common.exceptions.UnauthorizedException;
import com.nivlalulu.nnpro.common.hashing.IHashProvider;
import com.nivlalulu.nnpro.model.PasswordResetToken;
import com.nivlalulu.nnpro.repository.IPasswordResetTokenRepository;
import com.nivlalulu.nnpro.repository.IUserRepository;
import com.nivlalulu.nnpro.security.service.IRateLimiter;
import com.nivlalulu.nnpro.service.IUserCredentialsService;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.security.SecureRandom;
import java.time.Duration;
import java.time.Instant;
import java.util.Base64;

@Service
<span class="fc" id="L26">@Slf4j</span>
<span class="fc" id="L27">@RequiredArgsConstructor</span>
public class UserCredentialsService implements IUserCredentialsService {
    private final IUserRepository userRepository;
    private final IPasswordResetTokenRepository passwordResetTokenRepository;
    private final PasswordEncoder passwordEncoder;
    private final IMailSender mailSender;
    private final IHashProvider hashProvider;

    private final IRateLimiter rateLimiter;
<span class="fc" id="L36">    private final String PASSWORD_RESET_RATE_LIMIT_KEY = &quot;password&quot;;</span>
<span class="fc" id="L37">    private final int PASSWORD_RESET_RATE_LIMIT = 10;</span>
<span class="fc" id="L38">    private final Duration PASSWORD_RESET_RATE_WINDOW = Duration.ofMinutes(5);</span>


    @Override
    @Transactional
    public void createAndSendPasswordResetToken(String username) {
<span class="fc" id="L44">        String limitKey = PASSWORD_RESET_RATE_LIMIT_KEY + &quot;-&quot; + username;</span>
<span class="fc" id="L45">        var now = Instant.now();</span>
<span class="fc" id="L46">        var user = userRepository.findByUsername(username)</span>
<span class="fc" id="L47">                .orElseThrow(() -&gt; new NotFoundException(&quot;User&quot;, &quot;username&quot;, username));</span>
<span class="pc bpc" id="L48" title="1 of 2 branches missed.">        if (!rateLimiter.isAllowed(limitKey, PASSWORD_RESET_RATE_LIMIT, PASSWORD_RESET_RATE_WINDOW)) {</span>
<span class="nc" id="L49">            log.info(&quot;Rate limit exceeded for user {}&quot;, username);</span>
<span class="nc" id="L50">            throw new TooManyRequestsException(&quot;Too many password reset attempts. Please try again later.&quot;);</span>
        }
<span class="fc" id="L52">        var data = generateToken(now);</span>
<span class="fc" id="L53">        var token = passwordResetTokenRepository.findByUser(user)</span>
<span class="fc" id="L54">                .map(existing -&gt; {</span>
<span class="nc" id="L55">                    existing.setTokenHash(data.hash);</span>
<span class="nc" id="L56">                    existing.setExpiryDate(data.expiration);</span>
<span class="nc" id="L57">                    return existing;</span>
                })
<span class="fc" id="L59">                .orElseGet(() -&gt; new PasswordResetToken(data.hash, data.expiration, user));</span>
<span class="fc" id="L60">        log.debug(&quot;Generated token '{}' for user '{}', email '{}'.&quot;,</span>
<span class="fc" id="L61">                token.getTokenHash(),</span>
<span class="fc" id="L62">                user.getUsername(),</span>
<span class="fc" id="L63">                user.getEmail());</span>
<span class="fc" id="L64">        passwordResetTokenRepository.save(token);</span>
<span class="fc" id="L65">        log.debug(&quot;Sending password reset email to user '{}', email '{}'&quot;, user.getUsername(), user.getEmail());</span>
<span class="fc" id="L66">        mailSender.sendResetCode(user.getEmail(), data.token);</span>
<span class="fc" id="L67">    }</span>



    @Override
    @Transactional
    public void resetPassword(String token, String newPassword) {
<span class="nc" id="L74">        var hash = hashProvider.hash(token);</span>
<span class="nc" id="L75">        var passwordResetToken = passwordResetTokenRepository.findByTokenHash(hash)</span>
<span class="nc" id="L76">                .orElseThrow(() -&gt; {</span>
<span class="nc" id="L77">                    log.debug(&quot;Token does not exist&quot;);</span>
<span class="nc" id="L78">                    return new UnauthorizedException(&quot;Invalid password reset token&quot;);</span>
                });
<span class="nc" id="L80">        var user = passwordResetToken.getUser();</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (passwordResetToken.isExpired(Instant.now())) {</span>
<span class="nc" id="L82">            log.debug(&quot;Token expired for user {}&quot;, user.getUsername());</span>
<span class="nc" id="L83">            throw new UnauthorizedException(&quot;Invalid password reset token&quot;);</span>
        }
<span class="nc" id="L85">        log.debug(&quot;Password reset token found for user {}&quot;, user.getUsername());</span>
<span class="nc" id="L86">        var newPasswordHash = passwordEncoder.encode(newPassword);</span>
<span class="nc" id="L87">        user.setPassword(newPasswordHash);</span>
<span class="nc" id="L88">        user.setPasswordResetToken(null);</span>
<span class="nc" id="L89">        userRepository.save(user);</span>
<span class="nc" id="L90">    }</span>

    @Override
    @Transactional
    public void changePassword(String username, String oldPassword, String newPassword) {
<span class="nc" id="L95">        var user = userRepository.findByUsername(username)</span>
<span class="nc" id="L96">                .orElseThrow(() -&gt; new NotFoundException(&quot;User&quot;, &quot;username&quot;, username));</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (!passwordEncoder.matches(oldPassword, user.getPassword())) {</span>
<span class="nc" id="L98">            log.info(&quot;Old password is incorrect for user {}&quot;, username);</span>
<span class="nc" id="L99">            throw new UnauthorizedException(&quot;Password is incorrect&quot;);</span>
        }
<span class="nc" id="L101">        var newHash = passwordEncoder.encode(newPassword);</span>
<span class="nc" id="L102">        user.setPassword(newHash);</span>
<span class="nc" id="L103">        log.debug(&quot;Password changed for user {}&quot;, username);</span>
<span class="nc" id="L104">        userRepository.save(user);</span>
<span class="nc" id="L105">    }</span>

    @Override
    @Transactional
    public String changeUsername(String username, String newUsername) {
<span class="nc" id="L110">        var user = userRepository.findByUsername(username)</span>
<span class="nc" id="L111">                .orElseThrow(() -&gt; new NotFoundException(&quot;User&quot;, &quot;username&quot;, username));</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">        if (userRepository.existsByUsername(newUsername)) {</span>
<span class="nc" id="L113">            log.info(&quot;Username {} already exists&quot;, newUsername);</span>
<span class="nc" id="L114">            throw new ConflictException(&quot;User&quot;, &quot;username&quot;, username);</span>
        }
<span class="nc" id="L116">        user.setUsername(newUsername);</span>
<span class="nc" id="L117">        var saved = userRepository.save(user);</span>
<span class="nc" id="L118">        log.debug(&quot;Username changed for user {} to {}&quot;, username, saved.getUsername());</span>
<span class="nc" id="L119">        return saved.getUsername();</span>
    }

    @Override
    @Transactional
    public String changeEmail(String username, String newEmail) {
<span class="nc" id="L125">        var user = userRepository.findByUsername(username)</span>
<span class="nc" id="L126">                .orElseThrow(() -&gt; new NotFoundException(&quot;User&quot;, &quot;username&quot;, username));</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (userRepository.existsByEmail(newEmail)) {</span>
<span class="nc" id="L128">            log.info(&quot;Email {} already exists&quot;, newEmail);</span>
<span class="nc" id="L129">            throw new ConflictException(&quot;User&quot;, &quot;getEmail&quot;, newEmail);</span>
        }
<span class="nc" id="L131">        user.setEmail(newEmail);</span>
<span class="nc" id="L132">        var saved = userRepository.save(user);</span>
<span class="nc" id="L133">        log.debug(&quot;Email changed for user {} to {}&quot;, username, saved.getEmail());</span>
<span class="nc" id="L134">        return saved.getEmail();</span>
    }


<span class="fc" id="L138">    private record TokenData(String token, String hash, Instant expiration) {}</span>
    private TokenData generateToken(Instant now) {
<span class="fc" id="L140">        var random = new SecureRandom();</span>
<span class="fc" id="L141">        var bytes = new byte[64];</span>
<span class="fc" id="L142">        random.nextBytes(bytes);</span>
<span class="fc" id="L143">        var text = Base64.getUrlEncoder().withoutPadding().encodeToString(bytes);</span>
<span class="fc" id="L144">        var hash = hashProvider.hash(text);</span>
<span class="fc" id="L145">        var expiration = now.plusMillis(PasswordResetToken.EXPIRATION_MILLIS);</span>
<span class="fc" id="L146">        return new TokenData(text, hash, expiration);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>